<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./../../../style/dashboard/painel-administrativo/index-painel-administrativo.css">
    <link rel="stylesheet" href="./../../../style/dashboard/painel-administrativo/sidebar.css">
    <link rel="stylesheet" href="./../../../js/dashboard/painel-administrativo/js-barril/index.js">

    <title>Gerenciar Barris</title>
</head>
<body>
    <main class="content">
        <aside class="sidebar">
            <div class="sidebar-top">
                <div class="logo-wrap">
                    <img src="./../../../assets/imgs/logo-branca.png" alt="Logo WineTech" class="logo">
                </div>
            
                <nav class="nav">
                    <a href="./../gerenciar-funcionarios/index.html" class="nav-link">
                        <img src="./../../../assets/icones/painel-administrativo/funcionario-icon.svg" alt="Ícone Funcionário">
                        <span>Gerenciar Funcionários</span>
                    </a>
            
                    <a href="./../gerenciar-caves/index.html" class="nav-link">
                        <img src="./../../../assets/icones/painel-administrativo/cave-icon.svg" alt="Ícone Cave">
                        <span>Gerenciar Caves</span>
                    </a>
            
                    <a href="./../gerenciar-uvas/index.html" class="nav-link">
                        <img src="./../../../assets/icones/painel-administrativo/vinho-icon.svg" alt="Ícone Vinho">
                        <span>Gerenciar Uvas</span>
                    </a>

                    <a href="./../gerenciar-barris/index.html" class="nav-link">
                        <img src="./../../../assets/icones/painel-administrativo/barril-icon.svg" alt="Ícone Barril">
                        <span>Gerenciar Barris</span>
                    </a>
            
                    <a href="./../gerenciar-sensores/index.html" class="nav-link">
                        <img src="./../../../assets/icones/painel-administrativo/sensor-icon.svg" alt="Ícone Sensor">
                        <span>Gerenciar Sensores</span>
                    </a>
                </nav>
            </div>
            
            <div class="sidebar-bottom">
                <a href="./../../index-dashboard.html" class="btn-sidebar">
                    <img src="./../../../assets/icones/painel-administrativo/voltar-icon.svg" alt="Ícone Voltar">
                    <span>Voltar</span>
                </a>
            </div>
        </aside>

        <section class="main-content">
            <header class="main-content-header">
                <h2 class="title">Gerenciar Barris</h2>
            </header>
            
            <div class="table-container">
                <div class="actions">
                    <input type="search" placeholder="Busque por um barril...">
                    <button type="button" onclick="location.href='./cadastrar.html'">Cadastrar Barril</button>
                </div>
                
                <table class="table">
                    <tr class="table-title">
                        <th>ID</th>
                        <th>Identificação</th>
                        <th>Cave associada</th>
                        <th>Vinho armazenado</th>
                        <th>Editar</th>
                        <th>Excluir</th>
                    </tr>
                </table>
            </div>
        </section>
    </main>
</body>
<script>

    const ID_EMPRESA = sessionStorage.ID_EMPRESA;

    async function listar() {
        if (!ID_EMPRESA) {
            console.error("ID da empresa não encontrado!");
            return;
        }

        try {
            const resposta = await fetch(`/barris/listar?idEmpresa=${ID_EMPRESA}`, {
                method: "GET",
            });

            if (resposta.ok) {
                const listaDeCaves = await resposta.json();

                const tabela = document.querySelector(".table");

                const linhasAntigas = document.querySelectorAll(".table-content");
                linhasAntigas.forEach(linha => linha.remove());

                listaDeCaves.forEach(cave => {
                    const novaLinha = document.createElement("tr");
                    novaLinha.classList.add("table-content");

                    novaLinha.innerHTML = `
                        <td>${barril.id}</td>
                        <td>${barril.identificacao}</td>
                        <td>${barril.identificacao}</td>
                        <td>
                            <a href="./atualizar.html?id=${cave.id}">
                                <img src="./../../../assets/icones/painel-administrativo/editar-icon.svg" class="action-icon" alt="Ícone de editar">
                            </a>
                        </td>
                        <td>
                            <img src="./../../../assets/icones/painel-administrativo/delete-icon.svg" 
                                 class="action-icon" 
                                 alt="Ícone de deletar"
                                 onclick="deletar(${cave.id})" 
                                 style="cursor: pointer;">
                        </td>
                    `;

                    tabela.appendChild(novaLinha);
                });
            } else {
                console.error("Status do erro:", resposta.status);

                const erroTexto = await resposta.text();
                console.error("Mensagem do servidor:", erroTexto);
            }
        } catch (erro) {
            console.error("Erro na requisição:", erro);
        }
    }

    async function deletar(id) {
        const confirmacao = confirm("Tem certeza que deseja excluir esta cave?");

        if (confirmacao) {
            try {
                const resposta = await fetch(`/barris/deletar?idCave=${id}`, {
                    method: "GET"
                });

                if (resposta.ok) {
                    alert("Cave deletada com sucesso!");
                    listar();
                } else {
                    const erro = await resposta.json();
                    alert("Erro ao deletar: " + erro.mensagem);
                }
            } catch (erro) {
                console.error("Erro na requisição de delete:", erro);
            }
        }
    }

    async function pesquisar() {
        if (!ID_EMPRESA) {
            console.error("ID da empresa não encontrado!");
            return;
        }

        try {
            const resposta = await fetch(`/barris/pesquisar?idEmpresa=${ID_EMPRESA}`, {
                method: "GET",
            });

            if (resposta.ok) {
                const listaDeCaves = await resposta.json();

                const tabela = document.querySelector(".table");

                const linhasAntigas = document.querySelectorAll(".table-content");
                linhasAntigas.forEach(linha => linha.remove());

                listaDeCaves.forEach(cave => {
                    const novaLinha = document.createElement("tr");
                    novaLinha.classList.add("table-content");

                    novaLinha.innerHTML = `
                        <td>${cave.id}</td>
                        <td>${cave.identificacao}</td>
                        <td>
                            <a href="./atualizar.html?id=${cave.id}">
                                <img src="./../../../assets/icones/painel-administrativo/editar-icon.svg" class="action-icon" alt="Ícone de editar">
                            </a>
                        </td>
                        <td>
                            <img src="./../../../assets/icones/painel-administrativo/delete-icon.svg" 
                                 class="action-icon" 
                                 alt="Ícone de deletar"
                                 onclick="deletar(${cave.id})" 
                                 style="cursor: pointer;">
                        </td>
                    `;
                    tabela.appendChild(novaLinha);
                });
            } else {
                console.error("Status do erro:", resposta.status);

                const erroTexto = await resposta.text();
                console.error("Mensagem do servidor:", erroTexto);
            }
        } catch (erro) {
            console.error("Erro na requisição:", erro);
        }
    }

    // window.onload = pesquisar;
    window.onload = listar;
</script>
</html>