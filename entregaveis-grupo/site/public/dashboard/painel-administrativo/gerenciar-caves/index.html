<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./../../../style/dashboard/painel-administrativo/index-painel-administrativo.css">
    <link rel="stylesheet" href="./../../../style/dashboard/painel-administrativo/sidebar.css">
    <link rel="stylesheet" href="./../../../js/dashboard/painel-administrativo/js-caves/index.js">

    <title>Gerenciar Caves</title>
</head>

<body>
    <main class="content">
        <aside class="sidebar">
            <div class="sidebar-top">
                <div class="logo-wrap">
                    <img src="./../../../assets/imgs/logo-branca.png" alt="Logo WineTech" class="logo">
                </div>

                <nav class="nav">
                    <a href="./../gerenciar-funcionarios/index.html" class="nav-link">
                        <img src="./../../../assets/icones/painel-administrativo/funcionario-icon.svg"
                            alt="Ícone Funcionário">
                        <span>Gerenciar Funcionários</span>
                    </a>

                    <a href="./../gerenciar-caves/index.html" class="nav-link">
                        <img src="./../../../assets/icones/painel-administrativo/cave-icon.svg" alt="Ícone Cave">
                        <span>Gerenciar Caves</span>
                    </a>

                    <a href="./../gerenciar-uvas/index.html" class="nav-link">
                        <img src="./../../../assets/icones/painel-administrativo/vinho-icon.svg" alt="Ícone Vinho">
                        <span>Gerenciar Uvas</span>
                    </a>

                    <a href="./../gerenciar-barris/index.html" class="nav-link">
                        <img src="./../../../assets/icones/painel-administrativo/barril-icon.svg" alt="Ícone Barril">
                        <span>Gerenciar Barris</span>
                    </a>

                    <a href="./../gerenciar-sensores/index.html" class="nav-link">
                        <img src="./../../../assets/icones/painel-administrativo/sensor-icon.svg" alt="Ícone Sensor">
                        <span>Gerenciar Sensores</span>
                    </a>
                </nav>
            </div>

            <div class="sidebar-bottom">
                <a href="./../../index-dashboard.html" class="btn-sidebar">
                    <img src="./../../../assets/icones/painel-administrativo/voltar-icon.svg" alt="Ícone Voltar">
                    <span>Voltar</span>
                </a>
            </div>
        </aside>

        <section class="main-content">
            <header class="main-content-header">
                <h2 class="title">Gerenciar Caves</h2>
            </header>

            <div class="table-container">
                <div class="actions">
                    <input type="search" id="pesquisarVAR" oninput="pesquisar()" placeholder="Busque por uma cave...">
                    <button type="button" onclick="location.href='./cadastrar.html'">Cadastrar Cave</button>
                </div>

                <table class="table">
                    <tr class="table-title">
                        <th>ID</th>
                        <th>Identificação</th>
                        <th>Editar</th>
                        <th>Excluir</th>
                    </tr>
                </table>

            </div>
        </section>
    </main>
</body>
<script>

    const ID_EMPRESA = sessionStorage.ID_EMPRESA;

    // --- FUNÇÃO AUXILIAR PARA DESENHAR A TABELA ---
    // Criamos isso para não repetir o mesmo código dentro do listar() e do pesquisar()
    function plotarTabela(listaDeCaves) {
        const tabela = document.querySelector(".table");

        // Remove as linhas antigas para não duplicar
        const linhasAntigas = document.querySelectorAll(".table-content");
        linhasAntigas.forEach(linha => linha.remove());

        listaDeCaves.forEach(cave => {
            const novaLinha = document.createElement("tr");
            novaLinha.classList.add("table-content");

            // ATENÇÃO: Estou usando cave.idCave conforme arrumamos no seu Model.
            // Se você não alterou o Model, troque por cave.id aqui.
            novaLinha.innerHTML = `
                <td>${cave.id}</td>
                <td>${cave.identificacao}</td>
                <td>
                    <a href="./atualizar.html?id=${cave.id}">
                        <img src="./../../../assets/icones/painel-administrativo/editar-icon.svg" class="action-icon" alt="Ícone de editar">
                    </a>
                </td>
                <td>
                    <img src="./../../../assets/icones/painel-administrativo/delete-icon.svg" 
                            class="action-icon" 
                            alt="Ícone de deletar"
                            onclick="deletar(${cave.id})" 
                            style="cursor: pointer;">
                </td>
            `;

            tabela.appendChild(novaLinha);
        });
    }

    // --- FUNÇÃO LISTAR (Busca todas) ---
    async function listar() {
        if (!ID_EMPRESA) {
            console.error("ID da empresa não encontrado!");
            return;
        }

        try {
            const resposta = await fetch(`/caves/listar?idEmpresa=${ID_EMPRESA}`, {
                method: "GET",
            });

            if (resposta.ok) {
                const listaDeCaves = await resposta.json();
                plotarTabela(listaDeCaves); // Chama a função que desenha a tabela
            } else {
                console.error("Erro ao listar:", resposta.status);
            }
        } catch (erro) {
            console.error("Erro na requisição:", erro);
        }
    }

    // --- FUNÇÃO PESQUISAR (Busca por termo) ---
    async function pesquisar() {
        const inputPesquisa = document.getElementById("pesquisarVAR");
        const termoPesquisa = inputPesquisa.value;

        if (!ID_EMPRESA) {
            console.error("ID da empresa não encontrado!");
            return;
        }

        // Se o campo estiver vazio, listamos tudo para "limpar" a pesquisa
        if (termoPesquisa === "") {
            listar();
            return;
        }

        try {
            // Aqui adicionamos o &pesquisa=VALOR na URL para o Back-end receber
            const resposta = await fetch(`/caves/pesquisar?idEmpresa=${ID_EMPRESA}&pesquisa=${termoPesquisa}`, {
                method: "GET",
            });

            if (resposta.ok) {
                const listaDeCaves = await resposta.json();
                console.log(resposta.json)
                
                // Se a pesquisa não retornar nada, podemos limpar a tabela ou mostrar aviso
                if (listaDeCaves.length === 0) {
                     // Opcional: Avisar que não achou nada, ou só limpar a tabela
                }
                
                plotarTabela(listaDeCaves); // Reusa a mesma lógica de desenho
            } else {
                console.error("Erro ao pesquisar:", resposta.status);
            }
        } catch (erro) {
            console.error("Erro na requisição:", erro);
        }
    }

    // --- FUNÇÃO DELETAR ---
    async function deletar(id) {
        const confirmacao = confirm("Tem certeza que deseja excluir esta cave?");

        if (confirmacao) {
            try {
                const resposta = await fetch(`/caves/deletar?idCave=${id}`, {
                    method: "GET" // Lembrando que no seu router você usou GET para deletar
                });

                if (resposta.ok) {
                    alert("Cave deletada com sucesso!");
                    listar(); // Atualiza a lista
                } else {
                    const erro = await resposta.json();
                    alert("Erro ao deletar: " + erro.mensagem);
                }
            } catch (erro) {
                console.error("Erro na requisição de delete:", erro);
            }
        }
    }

    window.onload = listar;
</script>

</html>