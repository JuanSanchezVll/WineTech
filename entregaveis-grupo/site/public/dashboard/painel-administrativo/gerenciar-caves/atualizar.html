<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./../../../style/dashboard/painel-administrativo/form-painel-administrativo.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
        referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="./../../../js/dashboard/painel-administrativo/js-caves/atualizar.js">



    <title>Atualizar Cave</title>
</head>

<body onload="buscarCave()">
    <main class="content">
        <header class="header">
            <h2 class="titulo">Atualizar Cave</h2>
        </header>

        <form action="#" method="post" class="input-group">
            <div class="input-box">
                <img src="./../../../assets/icones/painel-administrativo/cave-icon-dark.svg" alt="">
                <input type="text" name="identificacao" id="identificacao" placeholder="Identificação" required>
            </div>

            <div class="buttons">
                <button type="button" class="btn btn-voltar" onclick="location.href='./index.html'">Voltar</button>
                <button type="button" class="btn btn-principal" onclick="atualizar()">Atualizar</button>
            </div>
        </form>
    </main>
</body>
<script>
    let idCaveGlobal = null;

    async function buscarCave() {
        try {
            const params = new URLSearchParams(window.location.search);
            idCaveGlobal = params.get('id');

            const resposta = await fetch(`/caves/listar?idEmpresa=${sessionStorage.ID_EMPRESA}&idCave=${idCaveGlobal}`);
            const cave = await resposta.json();

            const identificacao = document.getElementById("identificacao");

            identificacao.value = cave[0].identificacao;
        } catch (erro) {
            console.error("Erro ao  uva" + erro);
        }
    }
    async function atualizar() {
        const params = new URLSearchParams(window.location.search);
        const idCaveVar = params.get('id');

        const identificacaoVar = document.getElementById("identificacao").value;

        // Validações
        if (!idCaveVar) {
            alert("Erro: ID da cave não encontrado. Volte para a lista e tente novamente.");
            return;
        }

        if (identificacaoVar == "") {
            alert("Por favor, preencha a identificação da Cave.");
            return;
        }

        try {
            const resposta = await fetch("/caves/atualizar", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    idCave: idCaveVar,
                    identificacao: identificacaoVar
                }),
            });

            if (resposta.ok) {
                alert("Cave atualizada com sucesso!");
                window.location.href = "./index.html";
            } else {
                const erro = await resposta.json();
                alert("Erro ao atualizar: " + erro.mensagem);
            }
        } catch (erro) {
            console.error("Erro na requisição:", erro);
            alert("Erro interno. Verifique o console.");
        }
    }
</script>

</html>